 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>H.ai - your learning partner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--new codeeditor syntax color-->
   <!-- Add these to the head section -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>

  <!-- Bootstrap & Animations -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

  <!-- Dyslexia Font -->
  <link href="https://cdn.jsdelivr.net/gh/antijingoist/open-dyslexic/webkit/opendyslexic.css" rel="stylesheet" type="text/css">
  
  <!-- Markdown & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.2/dist/purify.min.js"></script>

  <style>
  .sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  width: 240px;
  background: #ffffff; /* White background */
  transform: translateX(-100%);
  transition: var(--transition);
  z-index: 1100;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
}

.sidebar.open {
  transform: translateX(0);
}

/* Sidebar Header */
.sidebar-header {
  background: var(--primary-gradient); /* Keep gradient on top header */
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sidebar-brand {
  color: white;
  font-weight: bold;
  font-size: 1.2rem;
  text-decoration: none;
}

.sidebar-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
}

/* Navigation Items */
.sidebar-nav {
  list-style: none;
  margin: 0;
  padding: 0;
}

.sidebar-nav li a {
  display: block;
  color: #333; /* Dark readable text */
  padding: 14px 20px;
  text-decoration: none;
  font-size: 0.95rem;
  transition: background 0.3s, color 0.3s, transform 0.2s;
  border-left: 4px solid transparent;
}

.sidebar-nav li a:hover {
  background-color: #f3f4f6; /* Soft gray hover */
  color: #111;
  border-left: 4px solid var(--accent-color); /* Gradient edge highlight */
  transform: translateX(4px); /* subtle shift */
}

/* Optional Active State (you can dynamically add 'active' class) */
.sidebar-nav li a.active {
  background-color: #ebf4ff;
  color: #2b6cb0;
  border-left: 4px solid #3182ce;
  font-weight: bold;
}


/* Overlay */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  background-color: rgba(0, 0, 0, 0.4);
  display: none;
  z-index: 1099;
}

.overlay.visible {
  display: block;
}

/* Hamburger button in wrapper */
.hamburger-wrapper {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1101;
  transition: var(--transition);
}

.hamburger-wrapper.shift {
  left: 255px;
}

.hamburger-btn {
  background: var(--primary-gradient);
  color: white;
  border: none;
  font-size: 1.3rem;
  padding: 10px 12px;
  border-radius: 6px;
  cursor: pointer;
}

body.sidebar-open {
  overflow: hidden; /* Prevent scrolling when sidebar is open */
}

/* Main content stays centered */
.main-content {
  padding: 20px;
  transition: var(--transition);
  margin-left: 0;
}

body.sidebar-open .main-content {
  filter: blur(1px);
  pointer-events: none;
}





    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, hsl(328, 66%, 57%) 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --dark-primary: #2d3748;
      --dark-secondary: #1a202c;
      --accent-color: #805ad5;
      --text-light: #718096;
      --border-radius: 16px;
      --shadow-light: 0 10px 30px rgba(0,0,0,0.1);
      --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      margin: 0;
      transition: var(--transition);
      line-height: 1.6;
    }

    .navbar {
      background: var(--primary-gradient);
      padding: 10px 0;
      box-shadow: var(--shadow-light);
    }

    .navbar-brand {
      color: white !important;
      font-weight: bold;
      font-size: 1.3rem;
    }

    .nav-pills .nav-link {
      color: rgba(255,255,255,0.8);
      margin: 0 3px;
      border-radius: 8px;
      transition: var(--transition);
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .nav-pills .nav-link.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .nav-pills .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .user-info {
      color: rgba(255,255,255,0.9);
      margin-right: 10px;
      font-size: 0.9rem;
    }

    .btn-logout {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.8rem;
    }

    .btn-logout:hover {
      background: rgba(255,255,255,0.3);
      color: white;
    }

    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      max-width: 1400px;
      margin: 10px auto;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-height: calc(100vh - 120px);
    }

    .content-area {
      padding: 20px;
    }

    .section {
      display: none;
      position: relative;
      z-index: 1;
    }

    .section.active {
      display: block;
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(0,0,0,0.05);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    /* Learn Section Layout */
    .learn-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      min-height: 65vh;
    }

    .learn-panel {
      background: white;
      border-radius: var(--border-radius);
      padding: 15px;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(0,0,0,0.05);
      overflow-y: auto;
      max-height: 65vh;
    }

    .panel-toggle {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.7rem;
      cursor: pointer;
      z-index: 10;
    }

    .panel-hidden {
      display: none;
    }

    /* Video Section */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .video-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow-light);
      transition: var(--transition);
      cursor: pointer;
    }

    .video-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .video-thumbnail {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .video-info {
      padding: 12px;
    }

    .video-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.85rem;
      line-height: 1.3;
    }

    .video-meta {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-bottom: 4px;
    }

    /* Video Modal Container - Full Screen with 70%-30% split */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      z-index: 9000;
      overflow: hidden;
    }

    .video-modal-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      transition: all 0.3s ease;
    }

    /* Video Player Container - 70% width when chat is open */
    .video-player-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: width 0.3s ease;
      padding: 10px;
      position: relative;
    }

    .video-player-container.with-chat {
      width: 70%;
    }

    .video-modal iframe {
      width: 100%;
      height: 100%;
      max-height: calc(100vh - 20px);
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    /* Control Buttons */
    .video-controls {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 10px;
      z-index: 9001;
    }

    .control-btn {
      background: rgba(0,0,0,0.7);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .control-btn:hover {
      background: rgba(0,0,0,0.9);
      transform: scale(1.1);
    }

    /* Video Chat in Modal - 30% width */
    .video-chat-in-modal {
      width: 0;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
      overflow: hidden;
      border-left: 3px solid var(--primary-gradient);
      box-shadow: -5px 0 15px rgba(0,0,0,0.3);
    }

    .video-chat-in-modal.show {
      width: 30%;
    }

    .video-chat-in-modal .video-chat-header {
      background: var(--primary-gradient);
      color: white;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 50px;
      flex-shrink: 0;
    }

    .video-chat-in-modal .video-chat-header h6 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .video-chat-in-modal .video-chat-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .video-transcript-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 10px 15px;
      font-size: 12px;
      flex-shrink: 0;
    }

    .video-chat-in-modal .video-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 15px;
      background: #f8fafc;
      min-height: 0;
    }

    .video-chat-in-modal .chat-message {
      margin-bottom: 12px;
    }

    .video-chat-in-modal .message-bubble {
      max-width: 90%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .video-chat-in-modal .message-bubble.user {
      background: var(--primary-gradient);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .video-chat-in-modal .message-bubble.ai {
      background: white ;
      border: 1px solid #e2e8f0;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      color: #333 !important;
    }

    .video-chat-in-modal .message-bubble.ai .markdown-body {
      color: #333 !important;
      background-color: white;
    }

    .video-chat-in-modal .message-bubble.ai .markdown-body p {
      color: #333 !important;
      background-color: white;
      margin-bottom: 0.3rem;
      font-size: 13px;
    }

    .video-chat-in-modal .message-bubble strong {
      font-size: 12px;
      display: block;
      margin-bottom: 4px;
    }

    .video-chat-in-modal .video-chat-input-area {
      padding: 12px 15px;
      border-top: 1px solid #e2e8f0;
      background: white;
      flex-shrink: 0;
    }

    .video-chat-in-modal .video-chat-input-area .form-control {
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 8px;
      resize: none;
      min-height: 36px;
      max-height: 80px;
    }

    .video-chat-in-modal .video-chat-input-area .btn {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 8px;
      min-width: 40px;
    }

    /* Form Styles */
    .form-section {
      display: grid;
      gap: 20px;
    }

    .form-group {
      position: relative;
    }

    .form-label {
      font-weight: 600;
      color: var(--dark-primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .form-control, .form-select {
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.9rem;
      transition: var(--transition);
      background: white;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.1);
      outline: none;
    }

    .btn-custom {
      background: var(--primary-gradient);
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      color: white;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      cursor: pointer;
    }

    .btn-custom:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      color: white;
    }

    .btn-secondary {
      background: #f7fafc;
      color: var(--dark-primary);
      border: 2px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #edf2f7;
      border-color: var(--accent-color);
      color: var(--dark-primary);
    }

    /* Chat Styles */
    .chat-container {
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      overflow: hidden;
      background: white;
      height: 95%;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8fafc;
    }

    .chat-message {
      margin-bottom: 12px;
      animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 14px;
      position: relative;
      word-wrap: break-word;
      font-size: 0.9rem;
    }

    .message-bubble.user {
      background: var(--primary-gradient);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.ai {
      background: white;
      border: 2px solid #e2e8f0;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .chat-input-area {
      padding: 12px;
      background: white;
      border-top: 2px solid #e2e8f0;
      display: flex;
      gap: 8px;
      align-items: end;
    }

    .chat-input {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 12px;
      resize: none;
      max-height: 80px;
      min-height: 36px;
      font-size: 0.9rem;
    }

    /* Profile Styles */
    .profile-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      z-index: 10000;
    }

    .activity-item {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-left: auto;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-bar {
      height: 3px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--success-gradient);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .navbar {
        padding: 8px 0;
      }
      
      .navbar-brand {
        font-size: 1.1rem;
      }
      
      .nav-pills .nav-link {
        padding: 6px 8px;
        font-size: 0.8rem;
        margin: 0 2px;
      }
      
      .main-container {
        margin: 5px;
        border-radius: 12px;
        min-height: calc(100vh - 100px);
      }
      
      .content-area {
        padding: 15px;
      }
      
      .card {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .learn-layout {
        grid-template-columns: 1fr;
        gap: 10px;
        min-height: 50vh;
      }
      
      .learn-panel {
        padding: 12px;
        max-height: 100%;
      }
      
      .video-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .video-thumbnail {
        height: 140px;
      }
      
      .video-info {
        padding: 10px;
      }
      
      .chat-container {
        height: 100%;
      }
      
      .form-section {
        gap: 15px;
      }
      
      .btn-custom {
        padding: 10px 20px;
        font-size: 0.9rem;
      }
      
      /* Mobile Video Modal */
      .video-modal-content {
        flex-direction: column;
      }
      
      .video-player-container {
        width: 100% !important;
        height: 60%;
        padding: 5px;
      }
      
      .video-player-container.with-chat {
        height: 60%;
      }
      
      .video-chat-in-modal {
        width: 100% !important;
        height: 0;
        border-left: none;
        border-top: 3px solid var(--primary-gradient);
      }
      
      .video-chat-in-modal.show {
        height: 40%;
      }
      
      .video-controls {
        top: 10px;
        right: 10px;
        gap: 8px;
      }
      
      .control-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      .video-modal iframe {
        border-radius: 6px;
      }
    }

    @media (max-width: 480px) {
      .content-area {
        padding: 10px;
      }
      
      .card {
        padding: 12px;
      }
      
      .navbar-brand {
        font-size: 1rem;
      }
      
      .nav-pills .nav-link {
        padding: 5px 6px;
        font-size: 0.75rem;
      }
      
      .user-info {
        font-size: 0.8rem;
        margin-right: 5px;
      }
      
      .btn-logout {
        padding: 4px 8px;
        font-size: 0.75rem;
      }
      
      .video-player-container.with-chat {
        height: 55%;
      }
      
      .video-chat-in-modal.show {
        height: 45%;
      }
      
      .video-controls {
        top: 8px;
        right: 8px;
        gap: 6px;
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .video-chat-in-modal .video-chat-header {
        padding: 10px 12px;
        min-height: 45px;
      }
      
      .video-chat-in-modal .video-chat-messages {
        padding: 8px 12px;
      }
      
      .video-chat-in-modal .video-chat-input-area {
        padding: 10px 12px;
      }
      
      .video-transcript-info {
        margin: 8px 12px;
        padding: 6px 10px;
        font-size: 11px;
      }
    }

    /* Scrollbar Styling */
    .video-chat-in-modal .video-chat-messages::-webkit-scrollbar {
      width: 4px;
    }

    .video-chat-in-modal .video-chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .video-chat-in-modal .video-chat-messages::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }

    .video-chat-in-modal .video-chat-messages::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* Animation for smooth transitions */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .video-chat-in-modal.show {
      animation: slideInRight 0.3s ease-out;
    }

    @media (max-width: 768px) {
      .video-chat-in-modal.show {
        animation: slideInUp 0.3s ease-out;
      }
    }



    /* Notes Section Styles */
.notes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.note-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: var(--shadow-light);
  border: 1px solid rgba(0,0,0,0.05);
  transition: var(--transition);
  cursor: pointer;
  position: relative;
  min-height: 200px;
}

.note-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}

.note-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.note-title {
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--dark-primary);
  margin: 0;
  line-height: 1.3;
}

.note-date {
  font-size: 0.8rem;
  color: var(--text-light);
}

.note-preview {
  color: #666;
  font-size: 0.9rem;
  line-height: 1.4;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
}

.note-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.note-card:hover .note-actions {
  opacity: 1;
}

.note-action-btn {
  background: rgba(0,0,0,0.7);
  border: none;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  margin-left: 5px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

.note-action-btn:hover {
  background: rgba(0,0,0,0.9);
}

/* Note Editor Styles */
.note-editor-container {
  background: #f5f5f5;
  min-height: 80vh;
  border-radius: 12px;
  overflow: hidden;
}

.note-editor-header {
  background: white;
  padding: 15px 20px;
  border-bottom: 1px solid #e2e8f0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.note-title-input {
  border: none;
  font-size: 1.3rem;
  font-weight: 600;
  padding: 8px 12px;
  border-radius: 8px;
  background: #f8fafc;
  min-width: 300px;
}

.note-title-input:focus {
  outline: none;
  background: white;
  box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.1);
}

/* PDF-like Editor */
.pdf-editor-container {
  padding: 20px;
  display: flex;
  justify-content: center;
  background: #e5e5e5;
  min-height: 600px;
}

.pdf-page {
  width: 210mm;
  min-height: 297mm;
  background: white;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  margin: 0 auto;
  position: relative;
  padding: 20mm;
  font-family: 'Times New Roman', serif;
}

.pdf-page-header {
  position: absolute;
  top: 10mm;
  right: 20mm;
  font-size: 10px;
  color: #666;
}

.pdf-page-content {
  min-height: calc(297mm - 60mm);
  padding-top: 10mm;
}

.note-editor-content {
  outline: none;
  font-size: 16px;
  line-height: 1.6;
  color: #333;
  min-height: 500px;
}

.note-editor-content p {
  margin-bottom: 12px;
}

.note-editor-content h1, .note-editor-content h2, .note-editor-content h3 {
  color: var(--dark-primary);
  margin-top: 20px;
  margin-bottom: 10px;
}

.pdf-page-footer {
  position: absolute;
  bottom: 10mm;
  left: 20mm;
  right: 20mm;
  text-align: center;
  font-size: 10px;
  color: #999;
  border-top: 1px solid #eee;
  padding-top: 5mm;
}

.app-watermark {
  font-style: italic;
}

/* Editor Toolbar */
.editor-toolbar {
  background: white;
  padding: 12px 20px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.toolbar-group {
  display: flex;
  gap: 5px;
  align-items: center;
}

.toolbar-btn {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  color: var(--dark-primary);
  width: 36px;
  height: 36px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.toolbar-btn:hover {
  background: var(--accent-color);
  color: white;
}

.toolbar-btn.active {
  background: var(--accent-color);
  color: white;
}

.toolbar-select {
  padding: 6px 10px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  background: white;
  font-size: 14px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .notes-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .pdf-page {
    width: 100%;
    min-height: auto;
    padding: 15px;
    margin: 0;
  }
  
  .pdf-editor-container {
    padding: 10px;
  }
  
  .note-title-input {
    min-width: 200px;
    font-size: 1.1rem;
  }
  
  .editor-toolbar {
    padding: 10px 15px;
    gap: 10px;
  }
  
  .toolbar-btn {
    width: 32px;
    height: 32px;
  }
}

@media (max-width: 480px) {
  .note-editor-header {
    padding: 12px 15px;
  }
  
  .note-editor-header .d-flex {
    flex-direction: column;
    gap: 10px;
    align-items: stretch !important;
  }
  
  .note-title-input {
    min-width: 100%;
  }
  
  .pdf-page {
    padding: 10px;
  }
  
  .note-editor-content {
    font-size: 14px;
    min-height: 300px;
  }
}



/* AI Notes Generator Styles */
.ai-notes-generator {
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow-light);
  margin-bottom: 20px;
}

.card-header {
  border-radius: 12px 12px 0 0 !important;
}

#ai-notes-content {
  font-family: 'Times New Roman', serif;
  line-height: 1.6;
}

#ai-notes-content h1, #ai-notes-content h2, #ai-notes-content h3 {
  color: var(--dark-primary);
  margin-top: 20px;
  margin-bottom: 10px;
}

#ai-notes-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}

#ai-notes-content table, #ai-notes-content th, #ai-notes-content td {
  border: 1px solid #ddd;
}

#ai-notes-content th, #ai-notes-content td {
  padding: 8px 12px;
  text-align: left;
}

#ai-notes-content th {
  background-color: #f8f9fa;
  font-weight: 600;
}

.ai-diagram {
  background: #f8f9fa;
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 15px 0;
  text-align: center;
  font-style: italic;
  color: #6c757d;
}

/* Mobile responsive for AI generator */
@media (max-width: 768px) {
  .ai-notes-generator .row {
    flex-direction: column;
  }
  
  .ai-notes-generator .col-md-6 {
    margin-bottom: 15px;
  }
}











  </style>

  <!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<!-- Python mode -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<!-- Theme (optional) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

</head>
<body>
 <!-- Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fas fa-brain"></i> H.ai</a>
      
      <div class="navbar-nav">
        <ul class="nav nav-pills">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-section="home">
              <i class="fas fa-home"></i> Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-section="learn">
              <i class="fas fa-book"></i> Learn
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-section="videos">
              <i class="fas fa-video"></i> Videos
            </a>
          </li>
          <!-- Add this after the Videos nav item -->
<li class="nav-item">
  <a class="nav-link" href="#" data-section="notes">
    <i class="fas fa-sticky-note"></i> Notes
  </a>
</li>


<!-- Add this after the Notes nav item -->
<!-- <li class="nav-item">
  <a class="nav-link" href="#" data-section="programming">
    <i class="fas fa-code"></i> Programming
  </a>
</li> -->


          <li class="nav-item">
            <a class="nav-link" href="#" data-section="assessment">
              <i class="fas fa-clipboard-check"></i> Assessment
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-section="profile">
              <i class="fas fa-user"></i> Profile
            </a>
          </li>
        </ul>
      </div>

      <div class="d-flex align-items-center">
        <span class="user-info" id="user-welcome">Welcome!</span>
        <a href="/logout" class="btn btn-logout">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>
  </nav>





<div class="hamburger-wrapper" id="hamburgerWrapper">
  <button class="hamburger-btn" id="hamburgerBtn" >
    <i class="fas fa-bars"></i>
  </button>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <a class="sidebar-brand" href="#"><i class="fas fa-brain"></i> H.ai</a>
    <button class="sidebar-close" id="sidebarClose"><i class="fas fa-times"></i></button>
  </div>
  <ul class="sidebar-nav">
    <li><a href="#" data-section="home"><i class="fas fa-home"></i> Home</a></li>
    <li><a href="#" data-section="learn"><i class="fas fa-book"></i> Learn</a></li>
    <li><a href="#" data-section="videos"><i class="fas fa-video"></i> Videos</a></li>
    <li><a href="#" data-section="notes"><i class="fas fa-sticky-note"></i> Notes</a></li>
    <!-- <li><a href="#" data-section="programming"><i class="fas fa-code"></i> Programming</a></li> -->
    <li><a href="#" data-section="assessment"><i class="fas fa-clipboard-check"></i> Assessment</a></li>
    <li><a href="#" data-section="profile"><i class="fas fa-user"></i> Profile</a></li>
  </ul>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>



  <div class="main-container">
    <div class="content-area">

      <!-- Home Section -->
      <div class="section active" id="home-section">
        <div class="text-center mb-4">
          <h1 class="display-5 mb-3">Welcome to H.ai AI</h1>
          <p class="lead text-muted">Your intelligent learning companion for accessible education</p>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="card">
              <h3><i class="fas fa-upload text-primary"></i> Document Learning</h3>
              <p>Upload PDF or text documents and get AI-powered summaries with audio support. Perfect for students with different learning needs.</p>
              <ul>
                <li>Intelligent text extraction</li>
                <li>Multi-language summarization</li>
                <li>Text-to-speech audio generation</li>
                <li>Interactive Q&A with AI</li>
              </ul>
            </div>
          </div>
          
          <div class="col-md-6 mb-3">
            <div class="card">
              <h3><i class="fas fa-video text-success"></i> Video Learning</h3>
              <p>Search and watch educational videos from YouTube with full accessibility features and organized viewing.</p>
              <ul>
                <li>AI-powered video search</li>
                <li>Embedded video player</li>
                <li>Fullscreen support</li>
                <li>Curated educational content</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-universal-access text-info"></i> Accessibility Features</h3>
          <div class="row">
            <div class="col-md-4">
              <h5>Visual Accessibility</h5>
              <ul>
                <li>Dyslexia-friendly fonts</li>
                <li>Dark mode support</li>
                <li>Adjustable font sizes</li>
                <li>High contrast options</li>
              </ul>
            </div>
            <div class="col-md-4">
              <h5>Audio Support</h5>
              <ul>
                <li>Text-to-speech</li>
                <li>Multiple language support</li>
                <li>Audio downloads</li>
                <li>Speed controls</li>
              </ul>
            </div>
            <div class="col-md-4">
              <h5>Learning Tools</h5>
              <ul>
                <li>AI-powered Q&A</li>
                <li>Interactive chat</li>
                <li>Progress tracking</li>
                <li>Personal activity log</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Learn Section -->
      <div class="section" id="learn-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="fas fa-book"></i> Document Learning</h2>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="togglePanel('upload-panel')">
              <i class="fas fa-eye-slash"></i> Upload docs tab
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="togglePanel('chat-panel')">
              <i class="fas fa-eye-slash"></i> Chat tab
            </button>
          </div>
        </div>

        <div class="learn-layout">
          <!-- Upload and Summary Panel -->
          <div class="learn-panel" id="upload-panel">
            <h4><i class="fas fa-cloud-upload-alt"></i> Upload & Process</h4>
            
            <form id="upload-form" class="form-section">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-file-alt"></i> Upload File (.pdf or .txt or .docs)
                </label>
                <input type="file" class="form-control" name="file" accept=".pdf,.txt,.docx,.csv" required>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <select class="form-select" name="language">
                    <option value="English">üá∫üá∏ English</option>
                    <option value="Spanish">üá™üá∏ Spanish</option>
                    <option value="French">üá´üá∑ French</option>
                    <option value="Hindi">üáÆüá≥ Hindi</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <select class="form-select" name="gtts_lang">
                    <option value="en">üá∫üá∏ English</option>
                    <option value="te">TE Telugu</option>
                    <option value="fr">üá´üá∑ French</option>
                    <option value="hi">üáÆüá≥ Hindi</option>
                  </select>
                </div>
              </div>

              <button type="submit" class="btn-custom w-100">
                <i class="fas fa-magic"></i> Generate Summary
              </button>
            </form>

            <div class="progress-bar" id="progress-bar" style="display: none;">
              <div class="progress-fill" id="progress-fill"></div>
            </div>

            <!-- Summary Display -->
            <div id="summary-section" style="display: none;">
              <h5 class="mt-3"><i class="fas fa-file-text"></i> Summary</h5>
              <div id="summary-content" class="p-3 bg-light rounded"></div>
              
              <div class="mt-3">
                <audio controls autoplay class="w-100" id="audioPlayer">
                  <source id="audioSource" type="audio/mp3">
                </audio>
              </div>
            </div>
          </div>

          <!-- Chat Panel -->
          <div class="learn-panel" id="chat-panel">
            <h4><i class="fas fa-comments"></i> Ask Questions</h4>
            
            <div class="chat-container">
              <div class="chat-messages" id="chat-messages">
                <div class="chat-message">
                  <div class="message-bubble ai">
                    <strong><i class="fas fa-robot"></i> H.ai:</strong>
                    <p>Hello! Upload a document and I'll help you understand it better. Ask me anything!</p>
                  </div>
                </div>
              </div>
              
              <div class="chat-input-area">
                <textarea class="chat-input" id="user-question" placeholder="Ask about the document..." rows="1"></textarea>
                <button class="btn-custom" id="ask-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Videos Section -->
      <div class="section" id="videos-section">
        <h2><i class="fas fa-video"></i> Educational Videos</h2>
        
        <div class="card">
          <div class="row">
            <div class="col-md-8">
              <input type="text" class="form-control" id="video-search" placeholder="Search for educational videos...">
            </div>
            <div class="col-md-4">
              <button class="btn-custom w-100" onclick="searchVideos()">
                <i class="fas fa-search"></i> Search Videos
              </button>
            </div>
          </div>
        </div>

        <div id="videos-container">
          <div class="text-center text-muted mt-4">
            <i class="fas fa-search fa-3x mb-3"></i>
            <p>Search for educational videos to get started</p>
          </div>
        </div>
      </div>
       <!-- Notes Section -->
<div class="section" id="notes-section">
  <div class="d-flex justify-content-between align-items-center mb-3">

  </div>
<!-- Add this after the existing header in notes-section -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="fas fa-sticky-note"></i> My Notes</h2>
  <div class="d-flex gap-2">
    <button class="btn btn-info" onclick="showAINotesGenerator()" id="ai-notes-btn">
      <i class="fas fa-robot"></i> AI Write Notes
    </button>
    <button class="btn-custom" onclick="createNewNote()">
      <i class="fas fa-plus"></i> New Note
    </button>
  </div>
</div>

<!-- Add AI Notes Generator Modal (add this before the existing note-editor-view) -->
<div id="ai-notes-generator" style="display: none;">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-robot"></i> AI Notes Generator</h5>
        <button class="btn btn-sm btn-outline-light" onclick="hideAINotesGenerator()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label"><i class="fas fa-lightbulb"></i> What would you like notes about?</label>
        <textarea 
          class="form-control" 
          id="ai-notes-prompt" 
          rows="4" 
          placeholder="Example: Create comprehensive notes about photosynthesis with diagrams and tables, or summarize the uploaded document with key points and flowcharts..."
        ></textarea>
      </div>
      
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Note Style</label>
          <select class="form-select" id="ai-notes-style">
            <option value="comprehensive">üìö Comprehensive Study Notes</option>
            <option value="summary">üìù Summary with Key Points</option>
            <option value="structured">üóÇÔ∏è Structured with Tables</option>
            <option value="visual">üìä Visual with Diagrams</option>
            <option value="outline">üìã Outline Format</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Include</label>
          <select class="form-select" id="ai-notes-features">
            <option value="all">üéØ Everything (Tables, Diagrams, Examples)</option>
            <option value="tables">üìä Focus on Tables & Charts</option>
            <option value="diagrams">üîÑ Focus on Flow Diagrams</option>
            <option value="examples">üí° Focus on Examples</option>
            <option value="definitions">üìñ Focus on Definitions</option>
          </select>
        </div>
      </div>
      
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="generateAINotes()" id="generate-ai-notes-btn">
          <i class="fas fa-magic"></i> Generate Notes
        </button>
        <button class="btn btn-secondary" onclick="useCurrentSummary()" id="use-summary-btn" disabled>
          <i class="fas fa-file-text"></i> Use Current Document
        </button>
      </div>
      
      <!-- AI Notes Preview -->
      <div id="ai-notes-preview" style="display: none;" class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6><i class="fas fa-eye"></i> Generated Notes Preview</h6>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" onclick="saveAINotesToEditor()">
              <i class="fas fa-save"></i> Save as Note
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="regenerateAINotes()">
              <i class="fas fa-redo"></i> Regenerate
            </button>
          </div>
        </div>
        <div id="ai-notes-content" class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>

  <!-- Notes List View -->
  <div id="notes-list-view">
    <div class="row" id="notes-grid">
      <div class="text-center text-muted mt-5 w-100">
        <i class="fas fa-sticky-note fa-3x mb-3"></i>
        <p>No notes yet. Create your first note!</p>
      </div>
    </div>
  </div>

  <!-- Note Editor View -->
  <div id="note-editor-view" style="display: none;">
    <div class="note-editor-container">
      <!-- Editor Header -->
      <div class="note-editor-header">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-secondary" onclick="backToNotesList()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <input type="text" id="note-title" class="note-title-input" placeholder="Note Title..." value="Untitled Note">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="saveNote()">
              <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-primary" onclick="downloadNotePDF()">
              <i class="fas fa-download"></i> Download PDF
            </button>
            <button class="btn btn-danger" onclick="deleteCurrentNote()" id="delete-note-btn" style="display: none;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>

      <!-- PDF-like Editor -->
      <div class="pdf-editor-container">
        <div class="pdf-page" id="note-content">
          <div class="pdf-page-header">
            <div class="page-number">Page 1</div>
          </div>
          <div class="pdf-page-content">
            <div id="note-editor" contenteditable="true" class="note-editor-content">
              <p>Start writing your note here...</p>
            </div>
          </div>
          <div class="pdf-page-footer">
            <div class="app-watermark">Created with H.ai - Your AI Learning Assistant</div>
          </div>
        </div>
      </div>

      <!-- Editor Toolbar -->
      <div class="editor-toolbar">
        <div class="toolbar-group">
          <button class="toolbar-btn" onclick="formatText('bold')" title="Bold">
            <i class="fas fa-bold"></i>
          </button>
          <button class="toolbar-btn" onclick="formatText('italic')" title="Italic">
            <i class="fas fa-italic"></i>
          </button>
          <button class="toolbar-btn" onclick="formatText('underline')" title="Underline">
            <i class="fas fa-underline"></i>
          </button>
        </div>
        <div class="toolbar-group">
          <button class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">
            <i class="fas fa-list-ul"></i>
          </button>
          <button class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">
            <i class="fas fa-list-ol"></i>
          </button>
        </div>
        <div class="toolbar-group">
          <select class="toolbar-select" onchange="changeFontSize(this.value)">
            <option value="14px">14px</option>
            <option value="16px" selected>16px</option>
            <option value="18px">18px</option>
            <option value="20px">20px</option>
            <option value="24px">24px</option>
          </select>
        </div>
        <div class="toolbar-group">
          <button class="toolbar-btn" onclick="insertCurrentDate()" title="Insert Date">
            <i class="fas fa-calendar"></i>
          </button>
          <button class="toolbar-btn" onclick="clearContent()" title="Clear All">
            <i class="fas fa-eraser"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>









      <!-- Assessment Section -->
      <div class="section" id="assessment-section">
        <h2><i class="fas fa-clipboard-check"></i> Assessment</h2>
        
        <div class="card" id="assessment-start">
          <div class="text-center">
            <i class="fas fa-clipboard-list fa-3x text-primary mb-3"></i>
            <h4>Ready to Test Your Knowledge?</h4>
            <p class="text-muted">Upload and process a document first, then generate an assessment to test your understanding.</p>
            <button class="btn-custom" onclick="generateAssessment()" id="generate-btn">
              <i class="fas fa-magic"></i> Generate Assessment
            </button>
          </div>
        </div>

        <div class="card" id="assessment-quiz" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="fas fa-question-circle"></i> Assessment Quiz</h4>
            <div class="badge bg-primary fs-6" id="question-counter">Question 1 of 5</div>
          </div>
          
          <div id="questions-container"></div>
          
          <div class="text-center mt-4">
            <button class="btn-custom" onclick="submitAssessment()" id="submit-assessment">
              <i class="fas fa-paper-plane"></i> Submit Assessment
            </button>
          </div>
        </div>

        <div class="card" id="assessment-results" style="display: none;">
          <div class="text-center">
            <div id="result-icon" class="mb-3"></div>
            <h3 id="result-title"></h3>
            <div class="row mt-4">
              <div class="col-md-3">
                <div class="text-center">
                  <h4 id="score-display" class="text-primary">0%</h4>
                  <small class="text-muted">Score</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h4 id="correct-display" class="text-success">0/5</h4>
                  <small class="text-muted">Correct</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h4 id="status-display">Failed</h4>
                  <small class="text-muted">Status</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h4 class="text-info">80%</h4>
                  <small class="text-muted">Pass Mark</small>
                </div>
              </div>
            </div>
            
            <div class="mt-4">
              <h5>AI Feedback</h5>
              <div id="ai-feedback" class="p-3 bg-light rounded text-start"></div>
            </div>
            
            <button class="btn-custom mt-3" onclick="resetAssessment()">
              <i class="fas fa-redo"></i> Take Another Assessment
            </button>
          </div>
        </div>
      </div>

      <!-- Profile Section -->
      <div class="section" id="profile-section">
        <div class="fas fa-user">
          <div class="row align-items-center">
            <div class="col-md-8">
              <!-- <h2><i class="fas fa-user-circle"></i> Profile</h2> -->
              <p class="mb-1" id="profile-username">Loading...</p>
              <p class="mb-0" id="profile-email">Loading...</p>
            </div>
            <div class="col-md-4 text-end">
              <a href="/logout" class="btn btn-light">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </div>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-chart-bar"></i> Assessment Dashboard</h3>
          <div id="assessment-dashboard">
            <div class="text-center text-muted">
              <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
              <p>Loading assessment data...</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-history"></i> Recent Activity</h3>
          <div id="activities-container">
            <div class="text-center text-muted">
              <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
              <p>Loading activities...</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Video Modal -->
  <div class="video-modal" id="video-modal">
    <div class="video-modal-content">
      <!-- Video Player Container -->
      <div class="video-player-container" id="video-player-container">
        <iframe id="video-iframe" src="" allowfullscreen></iframe>
        
        <!-- Video Controls -->
        <div class="video-controls">
          <button class="control-btn" id="chat-toggle-btn" onclick="toggleVideoChat()" title="Toggle Chat">
            <i class="fas fa-comments"></i>
          </button>
          <button class="control-btn" onclick="closeVideoModal()" title="Close Video">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- Video Chat in Modal -->
      <div class="video-chat-in-modal" id="video-chat-in-modal">
        <div class="video-chat-header">
          <h6><i class="fas fa-robot"></i> AI Assistant</h6>
          <button class="btn btn-sm btn-outline-light" id="close-video-chat-modal" style="padding: 4px 8px; font-size: 12px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="video-chat-body">
          <div id="video-transcript-info-modal" class="video-transcript-info" style="display: none;">
            <i class="fas fa-info-circle"></i>
            <strong>Transcript Ready!</strong>
            <span>Ask questions about this video.</span>
          </div>
          
          <div class="video-chat-messages" id="video-chat-messages-modal">
            <div class="chat-message">
              <div class="message-bubble ai">
                <strong><i class="fas fa-robot"></i> AI Assistant</strong>
                <p>Loading video transcript... Please wait a moment!</p>
              </div>
            </div>
          </div>
          
          <div class="video-chat-input-area">
            <div class="d-flex gap-2">
              <textarea 
                class="form-control" 
                id="video-question-input-modal" 
                placeholder="Ask about this video..."
                rows="1"
                disabled
              ></textarea>
              <button class="btn btn-primary" id="send-video-question-modal" disabled>
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let summaryContext = '';
    let isProcessing = false;
    let currentSection = 'home';
    let currentVideoTranscript = null;
    let currentVideoId = null; // Add this to track current video
    let isVideoChatOpen = false;
    let currentAssessment = null;
    let userAnswers = [];
    let generatedAIContent = '';
    // Initialize
   // Initialize - CONSOLIDATED VERSION
document.addEventListener('DOMContentLoaded', function() {
  // Load user info and setup navigation
  loadUserInfo();
  setupNavigation();
  setupEventListeners();
  
  // SIDEBAR FUNCTIONALITY - Add this to the existing DOMContentLoaded
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const hamburgerWrapper = document.getElementById('hamburgerWrapper');
  const sidebar = document.getElementById('sidebar');
  const sidebarClose = document.getElementById('sidebarClose');
  const overlay = document.getElementById('overlay');
  const body = document.body;

  // Check if elements exist
  if (!hamburgerBtn || !sidebar || !overlay) {
    console.error('Required sidebar elements not found');
    return;
  }

  function openSidebar() {
    console.log('Opening sidebar'); // Debug log
    sidebar.classList.add('open');
    overlay.classList.add('visible');
    if (hamburgerWrapper) hamburgerWrapper.classList.add('shift');
    body.classList.add('sidebar-open');
  }

  function closeSidebar() {
    console.log('Closing sidebar'); // Debug log
    sidebar.classList.remove('open');
    overlay.classList.remove('visible');
    if (hamburgerWrapper) hamburgerWrapper.classList.remove('shift');
    body.classList.remove('sidebar-open');
  }

  // Add event listeners
  hamburgerBtn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('Hamburger clicked'); // Debug log
    openSidebar();
  });
  
  if (sidebarClose) {
    sidebarClose.addEventListener('click', closeSidebar);
  }
  
  overlay.addEventListener('click', closeSidebar);
  
  document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") closeSidebar();
  });

  document.querySelectorAll('.sidebar-nav a').forEach(link => {
    link.addEventListener('click', function () {
      document.querySelectorAll('.sidebar-nav a').forEach(el => el.classList.remove('active'));
      this.classList.add('active');
      closeSidebar();
    });
  });
});

    function loadUserInfo() {
      fetch('/get_user_info')
        .then(response => response.json())
        .then(data => {
          if (data.id) {
            currentUser = data;
            document.getElementById('user-welcome').textContent = `Welcome, ${data.username}!`;
            document.getElementById('profile-username').textContent = data.username;
            document.getElementById('profile-email').textContent = data.email;
          }
        })
        .catch(error => console.error('Error loading user info:', error));
    }

    function setupNavigation() {
      document.querySelectorAll('[data-section]').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Update active nav link
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          this.classList.add('active');
          
          // Show section
          const sectionId = this.dataset.section + '-section';
          console.log(sectionId);
          currentSection = sectionId;
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          document.getElementById(sectionId).classList.add('active');
          
          // Load section-specific data
          if (sectionId === 'profile-section') {
            loadActivities();
            loadAssessmentDashboard();
          } 
          // Add this to your existing setupNavigation function
         else if (sectionId === 'notes-section') {
         loadUserNotes();
          }

          else if (sectionId === 'assessment-section') {
            checkAssessmentAvailability();
          }
          
        });
      });
    }

    function setupEventListeners() {
      document.getElementById('upload-form').addEventListener('submit', handleFormSubmit);
      document.getElementById('ask-btn').addEventListener('click', handleAskQuestion);
      document.getElementById('user-question').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleAskQuestion();
        }
      });
      document.getElementById('video-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchVideos();
        }
      });
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      
      if (isProcessing) return;
      isProcessing = true;

      const formData = new FormData(e.target);
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
      submitBtn.disabled = true;
      showProgress();

      try {
        const response = await fetch('/process', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        summaryContext = data.summary_text;

        // Show summary
        document.getElementById('summary-content').innerHTML = marked.parse(data.summary_text);
        document.getElementById('summary-section').style.display = 'block';

        // Setup audio
        if (data.audio_url) {
          document.getElementById('audioSource').src = data.audio_url;
          document.getElementById('audioPlayer').load();
        }

        // Enable assessment
        checkAssessmentAvailability();

      } catch (error) {
        console.error('Error processing file:', error);
        alert('Failed to process file. Please try again.');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        hideProgress();
        isProcessing = false;
      }
    }

    async function handleAskQuestion() {
      const questionInput = document.getElementById('user-question');
      const question = questionInput.value.trim();
      
      //if (!question || !summaryContext) return;

      const askBtn = document.getElementById('ask-btn');
      
      addChatMessage(question, 'user');
      questionInput.value = '';

      askBtn.innerHTML = '<span class="loading-spinner"></span>';
      askBtn.disabled = true;

      try {
        const response = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, context: summaryContext })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        if (data.videos) {
          displayVideos(data.videos);
          //document.getElementById('videos-section').classList.add('active');
          addChatMessage('I have added videos in the Videos section!', 'ai');
        } else if (data.answer) {
          addChatMessage(data.answer, 'ai');
        }

      } catch (error) {
        console.error('Error asking question:', error);
        addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
      } finally {
        askBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        askBtn.disabled = false;
      }
    }

    function addChatMessage(content, sender) {
      const chatMessages = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="message-bubble user">
            <strong><i class="fas fa-user"></i> You:</strong>
            <p>${escapeHtml(content)}</p>
          </div>
        `;
      } else {
        const html = marked.parse(content);
        messageDiv.innerHTML = `
          <div class="message-bubble ai">
            <strong><i class="fas fa-robot"></i> H.ai:</strong>
            <div>${html}</div>
          </div>
        `;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function searchVideos() {
      const query = document.getElementById('video-search').value.trim();
      if (!query) return;

      const container = document.getElementById('videos-container');
      container.innerHTML = '<div class="text-center"><div class="loading-spinner"></div> Searching videos...</div>';

      try {
        const response = await fetch('/search_videos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        displayVideos(data.videos);

      } catch (error) {
        console.error('Error searching videos:', error);
        container.innerHTML = '<div class="text-center text-danger">Error searching videos. Please try again.</div>';
      }
    }

    function displayVideos(videos) {
      const container = document.getElementById('videos-container');
      
      if (!videos || videos.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No videos found. Try a different search term.</div>';
        return;
      }

      const videosHtml = videos.map(video => `
        <div class="video-card" onclick="playVideo('${video.id}', '${escapeHtml(video.title)}')">
          <img src="${video.thumbnails[0]}" alt="${escapeHtml(video.title)}" class="video-thumbnail">
          <div class="video-info">
            <div class="video-title">${escapeHtml(video.title)}</div>
            <div class="video-meta">
              <i class="fas fa-user"></i> ${escapeHtml(video.channel)} ‚Ä¢ 
              <i class="fas fa-clock"></i> ${escapeHtml(video.duration)} ‚Ä¢ 
              <i class="fas fa-eye"></i> ${escapeHtml(video.views)}
            </div>
            <div class="video-meta">
              <i class="fas fa-calendar"></i> ${escapeHtml(video.publish_time)}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = `
        <div class="mb-3">
          <strong>${videos.length} videos found</strong>
        </div>
        <div class="video-grid">${videosHtml}</div>
      `;
    }

    // Updated playVideo function with 70%-30% split
    function playVideo(videoId, videoTitle) {
      const modal = document.getElementById('video-modal');
      const iframe = document.getElementById('video-iframe');
      const chatInModal = document.getElementById('video-chat-in-modal');
      const playerContainer = document.getElementById('video-player-container');
      const toggleBtn = document.getElementById('chat-toggle-btn');
      
      // Set video source
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
      modal.style.display = 'block';
      modal.classList.add('show');
      
      // Show chat by default with 30% width
      chatInModal.classList.add('show');
      playerContainer.classList.add('with-chat');
      toggleBtn.innerHTML = '<i class="fas fa-comment-slash"></i>';
      toggleBtn.title = 'Hide Chat';
      
      // Clear previous messages and reset transcript
      clearModalChatMessages();
      currentVideoTranscript = null;
      currentVideoId = videoId; // Track current video
      
      // Initialize modal chat
      initializeModalVideoChat();
      
      // Load transcript
      loadVideoTranscriptForModal(videoId);
      
      // Add loading message
      addVideoChatMessageModal('üîÑ Loading video transcript...', 'ai');
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }

    // Updated closeVideoModal function
    function closeVideoModal() {
      const modal = document.getElementById('video-modal');
      const iframe = document.getElementById('video-iframe');
      const chatInModal = document.getElementById('video-chat-in-modal');
      const playerContainer = document.getElementById('video-player-container');
      
      iframe.src = '';
      modal.style.display = 'none';
      modal.classList.remove('show');
      
      // Reset chat state
      chatInModal.classList.remove('show');
      playerContainer.classList.remove('with-chat');
      
      // Clear transcript and video ID
      currentVideoTranscript = null;
      currentVideoId = null;
      
      // Restore body scroll
      document.body.style.overflow = 'auto';
      
      // Reset toggle button
      const toggleBtn = document.getElementById('chat-toggle-btn');
      toggleBtn.innerHTML = '<i class="fas fa-comments"></i>';
      toggleBtn.title = 'Show Chat';
    }

    // Improved toggle video chat function
    function toggleVideoChat() {
      const chatInModal = document.getElementById('video-chat-in-modal');
      const playerContainer = document.getElementById('video-player-container');
      const toggleBtn = document.getElementById('chat-toggle-btn');
      
      if (chatInModal.classList.contains('show')) {
        // Hide chat - video takes full width
        chatInModal.classList.remove('show');
        playerContainer.classList.remove('with-chat');
        toggleBtn.innerHTML = '<i class="fas fa-comments"></i>';
        toggleBtn.title = 'Show Chat';
      } else {
        // Show chat - 70%-30% split
        chatInModal.classList.add('show');
        playerContainer.classList.add('with-chat');
        toggleBtn.innerHTML = '<i class="fas fa-comment-slash"></i>';
        toggleBtn.title = 'Hide Chat';
      }
    }

    // Initialize modal video chat with better error handling
    function initializeModalVideoChat() {
      const closeBtn = document.getElementById('close-video-chat-modal');
      const sendBtn = document.getElementById('send-video-question-modal');
      const questionInput = document.getElementById('video-question-input-modal');

      // Remove existing listeners to prevent duplicates
      const newCloseBtn = closeBtn.cloneNode(true);
      closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
      
      const newSendBtn = sendBtn.cloneNode(true);
      sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
      
      const newQuestionInput = questionInput.cloneNode(true);
      questionInput.parentNode.replaceChild(newQuestionInput, questionInput);

      // Add fresh event listeners
      document.getElementById('close-video-chat-modal').addEventListener('click', () => {
        toggleVideoChat();
      });

      document.getElementById('send-video-question-modal').addEventListener('click', sendVideoQuestionModal);
      
      document.getElementById('video-question-input-modal').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendVideoQuestionModal();
        }
      });
      
      // Auto-resize textarea
      document.getElementById('video-question-input-modal').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 80) + 'px';
      });
    }

    // Clear modal chat messages
    function clearModalChatMessages() {
      const chatMessages = document.getElementById('video-chat-messages-modal');
      chatMessages.innerHTML = '';
    }

    // Load transcript for modal with better feedback
    async function loadVideoTranscriptForModal(videoId) {
      try {
        const response = await fetch('/get_video_transcript', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ video_id: videoId })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Check if this is still the current video
        if (currentVideoId !== videoId) {
          console.log('Video changed, ignoring transcript response');
          return;
        }
        
        if (data.success && data.transcript) {
          currentVideoTranscript = data.transcript;
          
          // Enable chat input
          const questionInput = document.getElementById('video-question-input-modal');
          const sendBtn = document.getElementById('send-video-question-modal');
          
          questionInput.disabled = false;
          sendBtn.disabled = false;
          questionInput.placeholder = 'Ask about this video...';
          
          // Show transcript info
          document.getElementById('video-transcript-info-modal').style.display = 'block';
          
          // Add success message
          addVideoChatMessageModal('‚úÖ Ready! Ask me anything about this video.', 'ai');
          
        } else {
          // Handle no transcript case
          const questionInput = document.getElementById('video-question-input-modal');
          const sendBtn = document.getElementById('send-video-question-modal');
          
          questionInput.disabled = true;
          sendBtn.disabled = true;
          questionInput.placeholder = 'Transcript not available';
          
          addVideoChatMessageModal('‚ùå No transcript available for this video. The video might not have captions.', 'ai');
        }
      } catch (error) {
        console.error('Error loading transcript:', error);
        
        // Check if this is still the current video
        if (currentVideoId !== videoId) {
          return;
        }
        
        // Disable chat input on error
        const questionInput = document.getElementById('video-question-input-modal');
        const sendBtn = document.getElementById('send-video-question-modal');
        
        questionInput.disabled = true;
        sendBtn.disabled = true;
        questionInput.placeholder = 'Error loading transcript';
        
        addVideoChatMessageModal('‚ùå Error loading transcript. Please try refreshing the video.', 'ai');
      }
    }

    // Send video question in modal with improved UX
    async function sendVideoQuestionModal() {
      const questionInput = document.getElementById('video-question-input-modal');
      const question = questionInput.value.trim();
      
      if (!question) {
        questionInput.focus();
        return;
      }
      
      if (!currentVideoTranscript) {
        addVideoChatMessageModal('‚ö†Ô∏è Please wait for the transcript to load first.', 'ai');
        return;
      }

      const sendBtn = document.getElementById('send-video-question-modal');
      const originalBtnContent = sendBtn.innerHTML;
      
      // Add user message
      addVideoChatMessageModal(question, 'user');
      questionInput.value = '';
      questionInput.style.height = 'auto';

      // Show loading state
      sendBtn.innerHTML = '<div class="loading-spinner"></div>';
      sendBtn.disabled = true;
      questionInput.disabled = true;

      try {
        const response = await fetch('/ask_video', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            question: question,
            transcript: currentVideoTranscript 
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.answer) {
          addVideoChatMessageModal(data.answer, 'ai');
        } else {
          addVideoChatMessageModal('Sorry, I couldn\'t process your question. Please try rephrasing it.', 'ai');
        }

      } catch (error) {
        console.error('Error asking video question:', error);
        addVideoChatMessageModal('‚ùå Connection error. Please check your internet and try again.', 'ai');
      } finally {
        // Restore button state
        sendBtn.innerHTML = originalBtnContent;
        sendBtn.disabled = false;
        questionInput.disabled = false;
        questionInput.focus();
      }
    }

    // Add message to modal chat with improved styling
    function addVideoChatMessageModal(content, sender) {
      const chatMessages = document.getElementById('video-chat-messages-modal');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="message-bubble user">
            <strong><i class="fas fa-user"></i> You</strong>
            <p>${escapeHtml(content)}</p>
          </div>
        `;
      } else {
        const html = marked.parse(content);
        const safeHtml = DOMPurify.sanitize(html);
        messageDiv.innerHTML = `
          <div class="message-bubble ai">
            <strong><i class="fas fa-robot"></i> AI Assistant</strong>
            <div class="markdown-body">${safeHtml}</div>
          </div>
        `;
      }
      
      chatMessages.appendChild(messageDiv);
      
      // Smooth scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
    }

    function togglePanel(panelId) {
      const panel = document.getElementById(panelId);
      panel.classList.toggle('panel-hidden');
    }

    function loadActivities() {
      const container = document.getElementById('activities-container');
      
      fetch('/get_activities')
        .then(response => response.json())
        .then(activities => {
          if (activities.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No activities yet</div>';
            return;
          }

          const activitiesHtml = activities.map(activity => `
            <div class="activity-item">
              <div>
                <strong>${activity.action}</strong>
                ${activity.details ? `<br><small>${activity.details}</small>` : ''}
              </div>
              <div class="activity-time">${formatDate(activity.timestamp)}</div>
            </div>
          `).join('');

          container.innerHTML = activitiesHtml;
        })
        .catch(error => {
          console.error('Error loading activities:', error);
          container.innerHTML = '<div class="text-center text-danger">Error loading activities</div>';
        });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showProgress() {
      const progressBar = document.getElementById('progress-bar');
      const progressFill = document.getElementById('progress-fill');
      
      progressBar.style.display = 'block';
      
      let width = 0;
      const interval = setInterval(() => {
        width += Math.random() * 15;
        if (width >= 90) {
          clearInterval(interval);
          width = 90;
        }
        progressFill.style.width = width + '%';
      }, 500);
      
      progressBar._interval = interval;
    }

    function hideProgress() {
      const progressBar = document.getElementById('progress-bar');
      const progressFill = document.getElementById('progress-fill');
      
      if (progressBar._interval) {
        clearInterval(progressBar._interval);
      }
      
      progressFill.style.width = '100%';
      
      setTimeout(() => {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
      }, 500);
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Assessment Functions
    function checkAssessmentAvailability() {
      const generateBtn = document.getElementById('generate-btn');
      if (summaryContext) {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Assessment';
      } else {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Process a document first';
      }
    }

    async function generateAssessment() {
      if (!summaryContext) {
        alert('Please upload and process a document first');
        return;
      }

      const generateBtn = document.getElementById('generate-btn');
      const originalText = generateBtn.innerHTML;
      
      generateBtn.innerHTML = '<span class="loading-spinner"></span> Generating Questions...';
      generateBtn.disabled = true;

      try {
        const response = await fetch('/generate_assessment', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ summary: summaryContext })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server error:', errorText);
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        if (!data.questions || data.questions.length === 0) {
          throw new Error('No questions generated');
        }

        currentAssessment = data.questions;
        userAnswers = new Array(data.questions.length).fill('');
        
        displayQuestions(data.questions);
        document.getElementById('assessment-start').style.display = 'none';
        document.getElementById('assessment-quiz').style.display = 'block';

      } catch (error) {
        console.error('Error generating assessment:', error);
        alert(`Failed to generate assessment: ${error.message}`);
      } finally {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
      }
    }

    function displayQuestions(questions) {
      const container = document.getElementById('questions-container');
      
      const questionsHtml = questions.map((q, index) => `
        <div class="mb-4 p-3 border rounded">
          <h6>Question ${index + 1}</h6>
          <p><strong>${q.question}</strong></p>
          <div class="mt-3">
            ${q.options.map(option => `
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="question_${index}" 
                       value="${option.charAt(0)}" onchange="saveAnswer(${index}, '${option.charAt(0)}')">
                <label class="form-check-label">${option}</label>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
      
      container.innerHTML = questionsHtml;
    }

    function saveAnswer(questionIndex, answer) {
      userAnswers[questionIndex] = answer;
    }

    async function submitAssessment() {
      if (userAnswers.includes('')) {
        alert('Please answer all questions before submitting.');
        return;
      }

      const submitBtn = document.getElementById('submit-assessment');
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Evaluating...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/submit_assessment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            questions: currentAssessment,
            answers: userAnswers,
            document_title: 'Document Assessment'
          })
        });

        if (!response.ok) throw new Error('Failed to submit assessment');

        const result = await response.json();
        displayResults(result);

      } catch (error) {
        console.error('Error submitting assessment:', error);
        alert('Failed to submit assessment. Please try again.');
      } finally {
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Assessment';
        submitBtn.disabled = false;
      }
    }

    function displayResults(result) {
      document.getElementById('assessment-quiz').style.display = 'none';
      document.getElementById('assessment-results').style.display = 'block';
      
      const icon = result.passed ? 
        '<i class="fas fa-trophy fa-4x text-success"></i>' : 
        '<i class="fas fa-times-circle fa-4x text-danger"></i>';
      
      document.getElementById('result-icon').innerHTML = icon;
      document.getElementById('result-title').textContent = result.passed ? 
        'Congratulations! You Passed!' : 'Keep Learning!';
      document.getElementById('score-display').textContent = result.score + '%';
      document.getElementById('correct-display').textContent = 
        `${result.correct_count}/${result.total_questions}`;
      document.getElementById('status-display').textContent = result.passed ? 'Passed' : 'Failed';
      document.getElementById('status-display').className = result.passed ? 'text-success' : 'text-danger';
      document.getElementById('ai-feedback').innerHTML = marked.parse(result.feedback);
    }

    function resetAssessment() {
      document.getElementById('assessment-results').style.display = 'none';
      document.getElementById('assessment-start').style.display = 'block';
      currentAssessment = null;
      userAnswers = [];
      checkAssessmentAvailability();
    }

    async function loadAssessmentDashboard() {
      const container = document.getElementById('assessment-dashboard');
      
      try {
        const response = await fetch('/get_assessment_history');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          container.innerHTML = '<div class="text-center text-warning">Please log in to view assessment history</div>';
          return;
        }
        
        if (data.assessments.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted">
              <i class="fas fa-clipboard-list fa-3x mb-3"></i>
              <p>No assessments taken yet</p>
              <small>Complete your first assessment to see your progress here</small>
            </div>`;
          return;
        }

        const stats = data.stats;
        const dashboardHtml = `
          <div class="row mb-4">
            <div class="col-md-3 text-center">
              <h4 class="text-primary">${stats.total_attempted}</h4>
              <small>Total Attempted</small>
            </div>
            <div class="col-md-3 text-center">
              <h4 class="text-success">${stats.passed_count}</h4>
              <small>Passed</small>
            </div>
            <div class="col-md-3 text-center">
              <h4 class="text-info">${stats.pass_rate.toFixed(1)}%</h4>
              <small>Pass Rate</small>
            </div>
            <div class="col-md-3 text-center">
              <h4 class="text-warning">${stats.average_score}</h4>
              <small>Avg Score</small>
            </div>
          </div>
          <h5>Recent Assessments</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Document</th>
                  <th>Score</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${data.assessments.map(a => `
                  <tr>
                    <td>${a.document_title}</td>
                    <td><span class="badge ${a.score >= 80 ? 'bg-success' : 'bg-danger'}">${a.score}%</span></td>
                    <td><span class="badge ${a.passed ? 'bg-success' : 'bg-danger'}">${a.passed ? 'Passed' : 'Failed'}</span></td>
                    <td>${formatDate(a.created_at)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = dashboardHtml;
        
      } catch (error) {
        console.error('Error loading assessment dashboard:', error);
        container.innerHTML = `
          <div class="text-center text-danger">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <p>Error loading assessment data</p>
            <small>Please try refreshing the page</small>
          </div>`;
      }
    }

    // Handle modal click outside to close
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('video-modal');
      const modalContent = document.querySelector('.video-modal-content');
      
      if (e.target === modal && !modalContent.contains(e.target)) {
        closeVideoModal();
      }
    });

    // Handle escape key to close modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('video-modal');
        if (modal.style.display === 'block') {
          closeVideoModal();
        }
      }
    });

    // Prevent video modal from closing when clicking inside chat
    document.getElementById('video-chat-in-modal').addEventListener('click', function(e) {
      e.stopPropagation();
    });

    // Handle window resize for responsive behavior
    window.addEventListener('resize', function() {
      const modal = document.getElementById('video-modal');
      if (modal.style.display === 'block') {
        // Trigger reflow for responsive adjustments
        const chatInModal = document.getElementById('video-chat-in-modal');
        if (chatInModal.classList.contains('show')) {
          // Force recalculation of dimensions
          chatInModal.style.width = '';
          setTimeout(() => {
            chatInModal.classList.add('show');
          }, 10);
        }
      }
    });








    // Notes functionality
let currentNoteId = null;
let userNotes = [];

// Add to setupNavigation function - add notes section handling
if (sectionId === 'notes-section') {
  loadUserNotes();
}

// Notes Functions
async function loadUserNotes() {
  try {
    const response = await fetch('/get_user_notes');
    const data = await response.json();
    
    if (data.success) {
      userNotes = data.notes;
      displayNotesList();
    } else {
      console.error('Error loading notes:', data.error);
    }
  } catch (error) {
    console.error('Error loading notes:', error);
  }
}

function displayNotesList() {
  const container = document.getElementById('notes-grid');
  
  if (userNotes.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted mt-5 w-100">
        <i class="fas fa-sticky-note fa-3x mb-3"></i>
        <p>No notes yet. Create your first note!</p>
      </div>
    `;
    return;
  }

  const notesHtml = userNotes.map(note => `
    <div class="note-card" onclick="openNote(${note.id})">
      <div class="note-actions">
        <button class="note-action-btn" onclick="event.stopPropagation(); editNote(${note.id})" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="note-action-btn" onclick="event.stopPropagation(); deleteNote(${note.id})" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="note-card-header">
        <h5 class="note-title">${escapeHtml(note.title)}</h5>
        <span class="note-date">${formatDate(note.updated_at)}</span>
      </div>
      <div class="note-preview">${getTextPreview(note.content)}</div>
    </div>
  `).join('');

  container.innerHTML = `<div class="notes-grid">${notesHtml}</div>`;
}

function getTextPreview(htmlContent) {
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  const textContent = tempDiv.textContent || tempDiv.innerText || '';
  return escapeHtml(textContent.substring(0, 150) + (textContent.length > 150 ? '...' : ''));
}

function createNewNote() {
  currentNoteId = null;
  document.getElementById('note-title').value = 'Untitled Note';
  document.getElementById('note-editor').innerHTML = '<p>Start writing your note here...</p>';
  document.getElementById('delete-note-btn').style.display = 'none';
  showNoteEditor();
}

function openNote(noteId) {
  const note = userNotes.find(n => n.id === noteId);
  if (note) {
    currentNoteId = noteId;
    document.getElementById('note-title').value = note.title;
    document.getElementById('note-editor').innerHTML = note.content;
    document.getElementById('delete-note-btn').style.display = 'block';
    showNoteEditor();
  }
}

function editNote(noteId) {
  openNote(noteId);
}

function showNoteEditor() {
  document.getElementById('notes-list-view').style.display = 'none';
  document.getElementById('note-editor-view').style.display = 'block';
  document.getElementById('note-editor').focus();
}

function backToNotesList() {
  document.getElementById('note-editor-view').style.display = 'none';
  document.getElementById('notes-list-view').style.display = 'block';
  loadUserNotes();
}

async function saveNote() {
  const title = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-editor').innerHTML;
  
  if (!title) {
    alert('Please enter a note title');
    return;
  }

  const saveBtn = document.querySelector('[onclick="saveNote()"]');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
  saveBtn.disabled = true;

  try {
    const response = await fetch('/save_note', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: currentNoteId,
        title: title,
        content: content
      })
    });

    const data = await response.json();
    
    if (data.success) {
      currentNoteId = data.note_id;
      document.getElementById('delete-note-btn').style.display = 'block';
      
      // Show success message
      const successMsg = document.createElement('div');
      successMsg.className = 'alert alert-success';
      successMsg.innerHTML = '<i class="fas fa-check"></i> Note saved successfully!';
      successMsg.style.position = 'fixed';
      successMsg.style.top = '20px';
      successMsg.style.right = '20px';
      successMsg.style.zIndex = '10000';
      document.body.appendChild(successMsg);
      
      setTimeout(() => {
        document.body.removeChild(successMsg);
      }, 3000);
      
    } else {
      alert('Error saving note: ' + data.error);
    }
  } catch (error) {
    console.error('Error saving note:', error);
    alert('Error saving note. Please try again.');
  } finally {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

async function deleteNote(noteId) {
  if (!confirm('Are you sure you want to delete this note?')) {
    return;
  }

  try {
    const response = await fetch('/delete_note', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: noteId })
    });

    const data = await response.json();
    
    if (data.success) {
      loadUserNotes();
    } else {
      alert('Error deleting note: ' + data.error);
    }
  } catch (error) {
    console.error('Error deleting note:', error);
    alert('Error deleting note. Please try again.');
  }
}

async function deleteCurrentNote() {
  if (currentNoteId) {
    await deleteNote(currentNoteId);
    backToNotesList();
  }
}

// Editor Functions
function formatText(command) {
  document.execCommand(command, false, null);
  document.getElementById('note-editor').focus();
}

function changeFontSize(size) {
  document.execCommand('fontSize', false, '7');
  const fontElements = document.querySelectorAll('font[size="7"]');
  fontElements.forEach(el => {
    el.removeAttribute('size');
    el.style.fontSize = size;
  });
  document.getElementById('note-editor').focus();
}

function insertCurrentDate() {
  const date = new Date().toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  document.execCommand('insertText', false, date);
  document.getElementById('note-editor').focus();
}

function clearContent() {
  if (confirm('Are you sure you want to clear all content?')) {
    document.getElementById('note-editor').innerHTML = '<p>Start writing your note here...</p>';
    document.getElementById('note-editor').focus();
  }
}

// PDF Download Function
async function downloadNotePDF() {
  const title = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-editor').innerHTML;
  
  if (!title || !content) {
    alert('Please add content to your note before downloading');
    return;
  }

  const downloadBtn = document.querySelector('[onclick="downloadNotePDF()"]');
  const originalText = downloadBtn.innerHTML;
  downloadBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';
  downloadBtn.disabled = true;

  try {
    const response = await fetch('/download_note_pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: title,
        content: content
      })
    });

    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } else {
      alert('Error generating PDF. Please try again.');
    }
  } catch (error) {
    console.log('Error downloading PDF:', error);
    alert('Error downloading PDF. Please try again.');
  } finally {
    downloadBtn.innerHTML = originalText;
    downloadBtn.disabled = false;
  }
}

// Auto-save functionality (optional)
let autoSaveTimeout;
document.addEventListener('DOMContentLoaded', function() {
  const noteEditor = document.getElementById('note-editor');
  const noteTitle = document.getElementById('note-title');
  
  if (noteEditor) {
    noteEditor.addEventListener('input', function() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        if (currentNoteId && noteTitle.value.trim()) {
          saveNote();
        }
      }, 5000); // Auto-save after 5 seconds of inactivity
    });
  }
});


//code-editor

 const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
    mode: "python",
    lineNumbers: true,
    theme: "dracula", // or any other you included
    indentUnit: 4,
    tabSize: 4,
    indentWithTabs: false
  });


//save ai notes
// AI Notes Generator Functions - FIXED VERSION
// AI Notes Generator Functions - FIXED VERSION
// let generatedAIContent = ''; // Declare at the top level

// function showAINotesGenerator() {
//   document.getElementById('ai-notes-generator').style.display = 'block';
//   document.getElementById('notes-list-view').style.display = 'none';
  
//   // Enable "Use Current Document" button if summary exists
//   if (summaryContext) {
//     document.getElementById('use-summary-btn').disabled = false;
//   }
// }

// function hideAINotesGenerator() {
//   document.getElementById('ai-notes-generator').style.display = 'none';
//   document.getElementById('notes-list-view').style.display = 'block';
//   document.getElementById('ai-notes-preview').style.display = 'none';
// }

// function useCurrentSummary() {
//   if (summaryContext) {
//     document.getElementById('ai-notes-prompt').value = `Create detailed notes based on this content:\n\n${summaryContext.substring(0, 500)}...`;
//   } else {
//     alert('Please upload and process a document first in the Learn section.');
//   }
// }

// async function generateAINotes() {
//   const prompt = document.getElementById('ai-notes-prompt').value.trim();
//   const style = document.getElementById('ai-notes-style').value;
//   const features = document.getElementById('ai-notes-features').value;
  
//   if (!prompt) {
//     alert('Please enter what you want notes about');
//     return;
//   }

//   const generateBtn = document.getElementById('generate-ai-notes-btn');
//   const originalText = generateBtn.innerHTML;
//   generateBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';
//   generateBtn.disabled = true;

//   try {
//     const response = await fetch('/generate_ai_notes', {
//       method: 'POST',
//       headers: { 'Content-Type': 'application/json' },
//       body: JSON.stringify({
//         prompt: prompt,
//         style: style,
//         features: features,
//         context: summaryContext || ''
//       })
//     });

//     if (!response.ok) {
//       throw new Error(`HTTP error! status: ${response.status}`);
//     }

//     const data = await response.json();
//     console.log('AI Notes Response:', data);
    
//     if (data.success && data.notes) {
//       generatedAIContent = data.notes;
//       document.getElementById('ai-notes-content').innerHTML = data.notes;
//       document.getElementById('ai-notes-preview').style.display = 'block';
//     } else {
//       throw new Error(data.error || 'Failed to generate notes');
//     }
//   } catch (error) {
//     console.error('Error generating AI notes:', error);
//     alert('Error generating notes: ' + error.message);
//   } finally {
//     generateBtn.innerHTML = originalText;
//     generateBtn.disabled = false;
//   }
// }

// function saveAINotesToEditor() {
//   if (!generatedAIContent) {
//     alert('No notes to save');
//     return;
//   }
  
//   // Create new note with AI generated content
//   currentNoteId = null;
//   const prompt = document.getElementById('ai-notes-prompt').value.trim();
//   const title = `AI Notes: ${prompt.substring(0, 50)}${prompt.length > 50 ? '...' : ''}`;
  
//   document.getElementById('note-title').value = title;
//   document.getElementById('note-editor').innerHTML = generatedAIContent;
//   document.getElementById('delete-note-btn').style.display = 'none';
  
//   // Hide AI generator and show editor
//   hideAINotesGenerator();
//   showNoteEditor();
  
//   // Auto-save the note
//   setTimeout(() => {
//     saveNote();
//   }, 500);
// }

// AI Notes Generator Functions - FIXED VERSION
 // Move this to the top level and initialize properly

function showAINotesGenerator() {
  document.getElementById('ai-notes-generator').style.display = 'block';
  document.getElementById('notes-list-view').style.display = 'none';
  
  // Enable "Use Current Document" button if summary exists
  if (summaryContext) {
    document.getElementById('use-summary-btn').disabled = false;
  }
}

function hideAINotesGenerator() {
  document.getElementById('ai-notes-generator').style.display = 'none';
  document.getElementById('notes-list-view').style.display = 'block';
  document.getElementById('ai-notes-preview').style.display = 'none';
  // Reset the generated content
  generatedAIContent = '';
}

function useCurrentSummary() {
  if (summaryContext) {
    document.getElementById('ai-notes-prompt').value = `Create detailed notes based on this content:\n\n${summaryContext}...`;
  } else {
    alert('Please upload and process a document first in the Learn section.');
  }
}

async function generateAINotes() {
  const prompt = document.getElementById('ai-notes-prompt').value.trim();
  const style = document.getElementById('ai-notes-style').value;
  const features = document.getElementById('ai-notes-features').value;
  
  if (!prompt) {
    alert('Please enter what you want notes about');
    return;
  }

  const generateBtn = document.getElementById('generate-ai-notes-btn');
  const originalText = generateBtn.innerHTML;
  generateBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';
  generateBtn.disabled = true;

  // Reset the generated content at the start
  generatedAIContent = '';

  try {
    const response = await fetch('/generate_ai_notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: prompt,
        style: style,
        features: features,
        context: summaryContext || ''
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    console.log('AI Notes Response:', data);
    
    if (data.success && data.notes) {
      // Set the generated content
      generatedAIContent = data.notes;
      document.getElementById('ai-notes-content').innerHTML = data.notes;
      document.getElementById('ai-notes-preview').style.display = 'block';
    } else {
      throw new Error(data.error || 'Failed to generate notes');
    }
  } catch (error) {
    console.error('Error generating AI notes:', error);
    alert('Error generating notes: ' + error.message);
    // Reset content on error
    generatedAIContent = '';
  } finally {
    generateBtn.innerHTML = originalText;
    generateBtn.disabled = false;
  }
}

function regenerateAINotes() {
  // Simply call generateAINotes again
  generateAINotes();
}

function saveAINotesToEditor() {
  if (!generatedAIContent || generatedAIContent.trim() === '') {
    alert('No notes to save. Please generate notes first.');
    return;
  }
  
  // Create new note with AI generated content
  currentNoteId = null;
  const prompt = document.getElementById('ai-notes-prompt').value.trim();
  const title = `AI Notes: ${prompt.substring(0, 50)}${prompt.length > 50 ? '...' : ''}`;
  
  document.getElementById('note-title').value = title;
  document.getElementById('note-editor').innerHTML = generatedAIContent;
  document.getElementById('delete-note-btn').style.display = 'none';
  
  // Hide AI generator and show editor
  hideAINotesGenerator();
  showNoteEditor();
  
  // Auto-save the note
  setTimeout(() => {
    saveNote();
  }, 500);
}







//proggraming


// Programming Section Variables
let codeTemplates = {
  python: `# Welcome to H.ai Programming Lab!
# Write your Python code here and click Run

def hello_world():
    print("Hello, World!")
    return "Welcome to programming!"

# Call the function
result = hello_world()
print(f"Result: {result}")`,
  
  javascript: `// Welcome to H.ai Programming Lab!
// Write your JavaScript code here and click Run

function helloWorld() {
    console.log("Hello, World!");
    return "Welcome to programming!";
}

// Call the function
const result = helloWorld();
console.log(\`Result: \${result}\`);`,
  
  html: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H.ai Programming Lab</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hello, World!</h1>
        <p>Welcome to programming!</p>
    </div>
</body>
</html>`,
  
  java: `// Welcome to H.ai Programming Lab!
// Java concepts and examples

public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
        String result = "Welcome to programming!";
        System.out.println("Result: " + result);
    }
}`,
  
  cpp: `// Welcome to H.ai Programming Lab!
// C++ concepts and examples

#include <iostream>
#include <string>

int main() {
    std::cout << "Hello, World!" << std::endl;
    std::string result = "Welcome to programming!";
    std::cout << "Result: " << result << std::endl;
    return 0;
}`
};

// Add to setupNavigation function
if (sectionId === 'programming-section') {
  initializeProgrammingSection();
}

// Programming Functions
// Initialize CodeMirror when the programming section is loaded
function initializeProgrammingSection() {
  if (document.getElementById('code-editor')) {
    // Initialize CodeMirror if not already initialized
    if (!window.codeMirrorInstance) {
      window.codeMirrorInstance = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: "python",
        lineNumbers: true,
        theme: "dracula",
        indentUnit: 4,
        tabSize: 4,
        autoCloseBrackets: true,
        matchBrackets: true,
        lineWrapping: true,
        extraKeys: {
          "Tab": function(cm) {
            cm.replaceSelection("    ", "end");
          }
        }
      });
      
      // Set initial content
      window.codeMirrorInstance.setValue(codeTemplates.python);
    }
  }
}

// Update switchLanguage function to work with CodeMirror
function switchLanguage() {
  const language = document.getElementById('programming-language').value;
  
  if (window.codeMirrorInstance) {
    // Set new content
    window.codeMirrorInstance.setValue(codeTemplates[language] || '');
    
    // Change mode based on language
    let mode = "python";
    switch(language) {
      case 'javascript':
        mode = "javascript";
        break;
      case 'html':
        mode = "htmlmixed";
        break;
      case 'java':
        mode = "clike";
        break;
      case 'cpp':
        mode = "clike";
        break;
    }
    
    window.codeMirrorInstance.setOption("mode", mode);
  }
  
  // Clear output
  clearOutput();
  addOutputLine(`Switched to ${language.toUpperCase()} mode`, 'success');
}

function handleCodeEditorKeydown(e) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = e.target.selectionStart;
    const end = e.target.selectionEnd;
    e.target.value = e.target.value.substring(0, start) + '    ' + e.target.value.substring(end);
    e.target.selectionStart = e.target.selectionEnd = start + 4;
  }
}



function clearEditor() {
  const language = document.getElementById('programming-language').value;
  document.getElementById('code-editor').value = codeTemplates[language] || '';
  clearOutput();
  addOutputLine('Editor cleared', 'success');
}

function clearOutput() {
  document.getElementById('code-output-content').innerHTML = '';
}

function addOutputLine(text, type = 'normal') {
  const outputContent = document.getElementById('code-output-content');
  const line = document.createElement('div');
  line.className = `output-line ${type === 'error' ? 'output-error' : type === 'success' ? 'output-success' : ''}`;
  line.textContent = text;
  outputContent.appendChild(line);
  outputContent.scrollTop = outputContent.scrollHeight;
}

async function runCode() {
   let code = '';
  if (window.codeMirrorInstance) {
    code = window.codeMirrorInstance.getValue();
  } else {
    code = document.getElementById('code-editor').value;
  }
  
  const language = document.getElementById('programming-language').value;
  
  if (!code.trim()) {
    addOutputLine('No code to run', 'error');
    return;
  }
  
  clearOutput();
  addOutputLine(`Running ${language.toUpperCase()} code...`, 'success');
  
  
  try {
    const response = await fetch('/run_code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: code,
        language: language
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      if (result.output) {
        addOutputLine('Output:', 'success');
        addOutputLine(result.output);
      }
      if (result.error) {
        addOutputLine('Errors:', 'error');
        addOutputLine(result.error, 'error');
      }
      if (!result.output && !result.error) {
        addOutputLine('Code executed successfully (no output)', 'success');
      }
    } else {
      addOutputLine('Execution failed:', 'error');
      addOutputLine(result.error || 'Unknown error', 'error');
    }
  } catch (error) {
    console.error('Error running code:', error);
    addOutputLine('Network error: Could not execute code', 'error');
  }
}

function toggleProgrammingAI() {
  const panel = document.getElementById('programming-ai-panel');
  const toggleBtn = document.getElementById('programming-ai-toggle');
  
  if (panel.classList.contains('show')) {
    panel.classList.remove('show');
    toggleBtn.innerHTML = '<i class="fas fa-robot"></i> AI Assistant';
  } else {
    panel.classList.add('show');
    toggleBtn.innerHTML = '<i class="fas fa-times"></i> Hide AI';
  }
}

async function askProgrammingAI() {
  const questionInput = document.getElementById('programming-question');
  const question = questionInput.value.trim();
  
  if (!question) return;

  const currentCode = document.getElementById('code-editor').value;
  const language = document.getElementById('programming-language').value;

  addProgrammingMessage(question, 'user');
  questionInput.value = '';

  try {
    const response = await fetch('/ask_programming_ai', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        question,
        code: currentCode,
        language: language
      })
    });

    const data = await response.json();
    if (data.answer) {
      addProgrammingMessage(data.answer, 'ai');
    }
  } catch (error) {
    console.error('Error asking programming AI:', error);
    addProgrammingMessage('Sorry, I encountered an error. Please try again.', 'ai');
  }
}

function addProgrammingMessage(content, sender) {
  const messagesContainer = document.getElementById('programming-ai-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'chat-message';
  
  if (sender === 'user') {
    messageDiv.innerHTML = `
      <div class="message-bubble user">
        <strong><i class="fas fa-user"></i> You</strong>
        <p>${escapeHtml(content)}</p>
      </div>
    `;
  } else {
    const html = marked.parse(content);
    const safeHtml = DOMPurify.sanitize(html);
    messageDiv.innerHTML = `
      <div class="message-bubble ai">
        <strong><i class="fas fa-robot"></i> Code Assistant</strong>
        <div class="markdown-body">${safeHtml}</div>
      </div>
    `;
  }
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Keep your existing exam functions...


// Programming Exam Functions
function startProgrammingExam() {
  document.getElementById('programming-exam-modal').style.display = 'flex';
  document.getElementById('exam-setup').style.display = 'block';
  document.getElementById('exam-questions-container').style.display = 'none';
  document.getElementById('exam-results').style.display = 'none';
}

function closeProgrammingExam() {
  document.getElementById('programming-exam-modal').style.display = 'none';
  if (examTimer) {
    clearInterval(examTimer);
  }
}

async function generateProgrammingExam() {
  const language = document.getElementById('exam-language').value;
  const difficulty = document.getElementById('exam-difficulty').value;
  const type = document.getElementById('exam-type').value;
  const numQuestions = document.getElementById('exam-questions').value;

  try {
    const response = await fetch('/generate_programming_exam', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        language,
        difficulty,
        type,
        num_questions: numQuestions
      })
    });

    const data = await response.json();
    if (data.success) {
      programmingExamQuestions = data.questions;
      examAnswers = new Array(programmingExamQuestions.length).fill('');
      currentExamQuestion = 0;
      
      startExamTimer();
      showExamQuestion();
      
      document.getElementById('exam-setup').style.display = 'none';
      document.getElementById('exam-questions-container').style.display = 'block';
    }
  } catch (error) {
    console.error('Error generating exam:', error);
    alert('Error generating exam. Please try again.');
  }
}

function startExamTimer() {
  examStartTime = new Date();
  examTimer = setInterval(() => {
    const elapsed = new Date() - examStartTime;
    const minutes = Math.floor(elapsed / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    document.getElementById('exam-timer').textContent = 
      `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

function showExamQuestion() {
  const question = programmingExamQuestions[currentExamQuestion];
  const container = document.getElementById('exam-current-question');
  
  document.getElementById('exam-question-counter').textContent = 
    `Question ${currentExamQuestion + 1} of ${programmingExamQuestions.length}`;
  
  const progress = ((currentExamQuestion + 1) / programmingExamQuestions.length) * 100;
  document.getElementById('exam-progress-bar').style.width = progress + '%';
  
  if (question.type === 'coding') {
    container.innerHTML = `
      <div class="exam-question">
        <h6>Coding Problem</h6>
        <p><strong>${question.question}</strong></p>
        ${question.description ? `<p>${question.description}</p>` : ''}
        ${question.example ? `<div class="code-block">${question.example}</div>` : ''}
        <textarea class="form-control mt-3" rows="10" placeholder="Write your code here..." 
                  onchange="saveExamAnswer(${currentExamQuestion}, this.value)"></textarea>
      </div>
    `;
  } else {
    container.innerHTML = `
      <div class="exam-question">
        <h6>Question ${currentExamQuestion + 1}</h6>
        <p><strong>${question.question}</strong></p>
        <div class="mt-3">
          ${question.options.map((option, index) => `
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="exam_question_${currentExamQuestion}" 
                     value="${option.charAt(0)}" onchange="saveExamAnswer(${currentExamQuestion}, '${option.charAt(0)}')">
              <label class="form-check-label">${option}</label>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }



  //update-new

  // Programming Exam Variables
let programmingExamQuestions = [];
let currentExamQuestion = 0;
let examAnswers = [];
let examStartTime = null;
let examTimer = null;

// Fix the previous button functionality
function previousExamQuestion() {
  if (currentExamQuestion > 0) {
    // Save current answer before moving
    const currentAnswer = getExamAnswer();
    if (currentAnswer) {
      examAnswers[currentExamQuestion] = currentAnswer;
    }
    
    currentExamQuestion--;
    showExamQuestion();
    
    // Restore previous answer if exists
    setExamAnswer(examAnswers[currentExamQuestion]);
  }
}

// Helper to get current answer based on question type
function getExamAnswer() {
  const question = programmingExamQuestions[currentExamQuestion];
  if (question.type === 'coding') {
    const textarea = document.querySelector('#exam-current-question textarea');
    return textarea ? textarea.value : '';
  } else {
    const checkedRadio = document.querySelector(`input[name="exam_question_${currentExamQuestion}"]:checked`);
    return checkedRadio ? checkedRadio.value : '';
  }
}

// Helper to set answer for current question
function setExamAnswer(answer) {
  if (!answer) return;
  
  const question = programmingExamQuestions[currentExamQuestion];
  if (question.type === 'coding') {
    const textarea = document.querySelector('#exam-current-question textarea');
    if (textarea) textarea.value = answer;
  } else {
    const radio = document.querySelector(`input[name="exam_question_${currentExamQuestion}"][value="${answer}"]`);
    if (radio) radio.checked = true;
  }
}

// Fix next button functionality
function nextExamQuestion() {
  if (currentExamQuestion < programmingExamQuestions.length - 1) {
    // Save current answer before moving
    const currentAnswer = getExamAnswer();
    if (currentAnswer) {
      examAnswers[currentExamQuestion] = currentAnswer;
    }
    
    currentExamQuestion++;
    showExamQuestion();
    
    // Restore next answer if exists
    setExamAnswer(examAnswers[currentExamQuestion]);
  }
}

  
  // Update navigation buttons
  document.getElementById('exam-prev-btn').disabled = currentExamQuestion === 0;
  document.getElementById('exam-next-btn').style.display = 
    currentExamQuestion === programmingExamQuestions.length - 1 ? 'none' : 'inline-block';
  document.getElementById('exam-submit-btn').style.display = 
    currentExamQuestion === programmingExamQuestions.length - 1 ? 'inline-block' : 'none';
}

function saveExamAnswer(questionIndex, answer) {
  examAnswers[questionIndex] = answer;
}



async function submitProgrammingExam() {
  if (examTimer) {
    clearInterval(examTimer);
  }
  
  const examTime = new Date() - examStartTime;
  
  try {
    const response = await fetch('/submit_programming_exam', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        questions: programmingExamQuestions,
        answers: examAnswers,
        exam_time: examTime
      })
    });

    const result = await response.json();
    displayExamResults(result, examTime);
  } catch (error) {
    console.error('Error submitting exam:', error);
    alert('Error submitting exam. Please try again.');
  }
}

function displayExamResults(result, examTime) {
  document.getElementById('exam-questions-container').style.display = 'none';
  document.getElementById('exam-results').style.display = 'block';
  
  const minutes = Math.floor(examTime / 60000);
  const seconds = Math.floor((examTime % 60000) / 1000);
  
  document.getElementById('exam-result-icon').innerHTML = result.passed ? 
    '<i class="fas fa-trophy fa-4x text-success"></i>' : 
    '<i class="fas fa-code fa-4x text-warning"></i>';
  document.getElementById('exam-result-title').textContent = result.passed ? 
    'Excellent Work!' : 'Keep Practicing!';
  document.getElementById('exam-score-display').textContent = result.score + '%';
  document.getElementById('exam-correct-display').textContent = 
    `${result.correct_count}/${result.total_questions}`;
  document.getElementById('exam-time-display').textContent = 
    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  document.getElementById('exam-status-display').textContent = result.passed ? 'Passed' : 'Needs Improvement';
  document.getElementById('exam-status-display').className = result.passed ? 'text-success' : 'text-warning';
  document.getElementById('exam-ai-feedback').innerHTML = marked.parse(result.feedback);
}

function resetProgrammingExam() {
  document.getElementById('exam-results').style.display = 'none';
  document.getElementById('exam-setup').style.display = 'block';
  programmingExamQuestions = [];
  examAnswers = [];
  currentExamQuestion = 0;
}

// Add keyboard shortcuts for programming
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.ctrlKey) {
    const activeElement = document.activeElement;
    if (activeElement && activeElement.id === 'programming-question') {
      askProgrammingAI();
    }
  }
});







  </script>
</body>
</html>
